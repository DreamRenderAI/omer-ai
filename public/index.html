<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bixx AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #161618;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Inter', 'Inter Fallback', Roboto, 'Open Sans', Arial, sans-serif;
            font-weight: 400;
            overflow: hidden;
            scrollbar-width: thin;
            scrollbar-color: #242628 #161618;
            transition: background-color 0.3s ease;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        html {
            height: 100%;
        }
        body.light-theme {
            background-color: #ffffff;
            scrollbar-color: #e0e0e0 #f5f5f5;
        }
        body::-webkit-scrollbar-track {
            background: #161618;
        }
        body.light-theme::-webkit-scrollbar-track {
            background: #f5f5f5;
        }
        body::-webkit-scrollbar-thumb {
            background: #242628;
            border-radius: 4px;
        }
        body.light-theme::-webkit-scrollbar-thumb {
            background: #e0e0e0;
        }
        body::-webkit-scrollbar-thumb:hover {
            background: #2c2e30;
        }
        body.light-theme::-webkit-scrollbar-thumb:hover {
            background: #cccccc;
        }
        .header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 20px;
            position: sticky;
            top: 0;
            background-color: #161618;
            z-index: 11;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
            height: 60px;
        }
        .header.light-theme {
            background-color: #ffffff;
        }
        .profile-container {
            position: relative;
            display: inline-block;
        }
        .profile-icon {
            background-color: #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #000000;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .light-theme .profile-icon {
            background-color: #333333;
            color: #ffffff;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background-color: #242628;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            min-width: 150px;
            z-index: 12;
            transition: background-color 0.3s ease;
        }
        .light-theme .dropdown-menu {
            background-color: #e0e0e0;
        }
        .dropdown-menu.active {
            display: block;
        }
        .dropdown-item {
            padding: 10px 15px;
            color: white;
            font-size: 14px;
            text-align: left;
            cursor: default;
            transition: color 0.3s ease;
        }
        .light-theme .dropdown-item {
            color: #333333;
        }
        .dropdown-button {
            padding: 10px 15px;
            color: white;
            font-size: 14px;
            background: none;
            border: none;
            text-align: left;
            width: 100%;
            cursor: pointer;
            font-family: 'Inter', 'Inter Fallback', Roboto, 'Open Sans', Arial, sans-serif;
            font-weight: 400;
            transition: color 0.3s ease;
        }
        .light-theme .dropdown-button {
            color: #333333;
        }
        .dropdown-button:hover {
            background-color: #2c2e30;
        }
        .light-theme .dropdown-button:hover {
            background-color: #cccccc;
        }
        .title {
            color: white;
            font-size: 30px;
            text-align: center;
            padding: 20px 0;
            font-family: 'Inter', 'Inter Fallback', Roboto, 'Open Sans', Arial, sans-serif;
            font-weight: 300;
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            transition: all 0.3s ease;
        }
        .light-theme .title {
            color: #333333;
        }
        .title.hidden {
            display: none;
        }
        .example-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            opacity: 1;
            transition: opacity 0.3s ease;
            position: absolute;
            bottom: 35%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 800px;
            padding: 0 20px;
        }
        .example-buttons.hidden {
            display: none;
        }
        .example-button {
            background: linear-gradient(145deg, #2a2c2e, #242628);
            color: #ffffff;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 160px;
            justify-content: center;
        }
        .example-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(145deg, #2c2e30, #26282a);
        }
        .example-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .light-theme .example-button {
            background: linear-gradient(145deg, #e8e8e8, #d8d8d8);
            color: #333333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .light-theme .example-button:hover {
            background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .button-icon {
            font-size: 16px;
            opacity: 0.9;
        }
        .message-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            gap: 20px;
            padding-bottom: 150px;
            padding-top: 60px;
        }
        .user-message {
            color: white;
            font-size: 16px;
            text-align: right;
            margin: 0;
            overflow-wrap: break-word;
            max-width: 90%;
            align-self: flex-end;
            background-color: #242628;
            padding: 10px 15px;
            border-radius: 15px;
            transition: color 0.3s ease, background-color 0.3s ease;
            position: relative;
            z-index: 1;
        }
        .light-theme .user-message {
            color: #333333;
            background-color: #e0e0e0;
        }
        .ai-message {
            color: white;
            font-size: 16px;
            text-align: left;
            margin: 0;
            overflow-wrap: break-word;
            max-width: 90%;
            align-self: flex-start;
            word-spacing: 2px;
            transition: color 0.3s ease;
            position: relative;
            z-index: 1;
        }
        .light-theme .ai-message {
            color: #333333;
        }
        /* Style for the container holding image, loader, or placeholder within AI message */
        .ai-message .flex-1 {
            position: relative; /* Needed for absolute positioning of image, loader, and placeholder */
            min-height: 250px; /* Ensure there's space for loader/placeholder/image */
            display: flex; /* Use flex to potentially center smaller images/loaders */
            justify-content: center;
            align-items: center;
            min-width: 260px; /* Ensure enough width for the image */
        }
        .ai-message .placeholder {
            width: 250px; /* Match image size */
            height: 250px; /* Match image size */
            background-color: #303133; /* Gray placeholder */
            border-radius: 8px;
            position: absolute;
            top: 50%;
            left: 50%; /* Position from the left edge, moving it right */
            right: auto; /* Remove right positioning */
            transform: translate(-50%, -50%);
            z-index: 0; /* Behind loader and image */
        }
        .ai-message .loader {
            width: 80px; /* Make loader smaller than the image */
            aspect-ratio: 1;
            position: absolute; /* Position absolutely within flex-1 container */
            top: 50%;
            left: 75%; /* Position from the left edge, moving it right */
            right: auto; /* Remove right positioning */
            transform: translate(-50%, -50%); /* Keep centered relative to new left */
            z-index: 1; /* Ensure loader is above placeholder but below image */
        }
        .ai-message img {
            width: 250px; /* Set a fixed width for the image */
            height: 250px; /* Set a fixed height for the image */
            object-fit: cover;
            border-radius: 8px;
            display: block;
            position: absolute; /* Position relative within flex container */
            top: 50%;
            left: 75%; /* Position from the left edge, moving it right */
            right: auto; /* Remove right positioning */
            transform: translate(-50%, -50%); /* Keep centered relative to new left */
            z-index: 2; /* Ensure image is above loader and placeholder */
        }
        .image-message {
            margin: 0;
            max-width: 90%;
            align-self: flex-start;
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #242628;
            border-radius: 8px;
            overflow: hidden;
            z-index: 1;
        }
        .image-message img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .image-message.error {
            color: white;
            font-size: 14px;
            text-align: left;
            margin: 0;
            align-self: flex-start;
            padding: 10px 15px;
            background-color: #242628;
            border-radius: 8px;
        }
        .light-theme .image-message {
            background-color: #e0e0e0;
        }
        .light-theme .image-message.error {
            color: #333333;
            background-color: #e0e0e0;
        }
        .loading-icon {
            width: 40px;
            height: 40px;
            border: 3px solid #ffffff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 15px 10px;
            align-self: flex-start;
            display: block !important;
            z-index: 1;
        }
        .light-theme .loading-icon {
            border: 3px solid #333333;
            border-top: 3px solid transparent;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader {
            width: 80px;
            aspect-ratio: 1;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        .loader:before,
        .loader:after {
            content: "";
            position: absolute;
            border-radius: 50px;
            box-shadow: 0 0 0 3px inset #fff;
            animation: l4 2.5s infinite;
        }
        @keyframes l4 {
            0% {
                inset: 0 35px 35px 0;
            }
            12.5% {
                inset: 0 35px 0 0;
            }
            25% {
                inset: 35px 35px 0 0;
            }
            37.5% {
                inset: 35px 0 0 0;
            }
            50% {
                inset: 35px 0 0 35px;
            }
            62.5% {
                inset: 0 0 0 35px;
            }
            75% {
                inset: 0 0 35px 35px;
            }
            87.5% {
                inset: 0 0 35px 0;
            }
            100% {
                inset: 0 35px 35px 0;
            }
        }
        .input-container {
            width: 100%;
            max-width: 800px;
            height: 100px;
            background-color: #242628;
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            position: fixed;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            z-index: 10;
            transition: all 0.3s ease;
        }
        .input-container.moved-down {
            bottom: 0px;
            transform: translateX(-50%);
        }
        .light-theme .input-container {
            background-color: #e0e0e0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .input-label {
            color: #d3d3d3;
            font-size: 16px;
            margin-bottom: 5px;
            font-family: 'Inter', 'Inter Fallback', Arial, sans-serif;
            font-weight: 400;
            transition: color 0.3s ease;
        }
        .light-theme .input-label {
            color: #333333;
        }
        .input-text {
            color: #d3d3d3;
            font-size: 16px;
            flex-grow: 1;
            border: none;
            background: none;
            outline: none;
            white-space: pre-wrap;
            font-family: 'Inter', 'Inter Fallback', Arial, sans-serif;
            font-weight: 400;
            transition: color 0.3s ease;
        }
        .light-theme .input-text {
            color: #333333;
        }
        .light-theme .input-text::placeholder {
            color: #666666;
        }
        .button-group {
            display: flex;
            justify-content: flex-end;
        }
        button {
            background: none;
            border: none;
            cursor: pointer;
        }
        .circle-button {
            background-color: #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #000000;
            font-size: 36px;
            font-weight: bold;
            padding: 0;
            border: none;
            cursor: pointer;
        }
        .circle-button img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }
        .light-theme .circle-button {
            background-color: #333333;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="loader"></div>
        <div class="profile-container">
            <div class="profile-icon" onclick="toggleDropdown()">
                <i class="fas fa-user"></i>
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-item">Free User</div>
                <button class="dropdown-button" onclick="newChat()">New Chat</button>
                <button class="dropdown-button" id="theme-button" onclick="toggleTheme()">Switch to Light Theme</button>
            </div>
        </div>
    </div>
    <div class="title" id="title">Bixx AI By Omer</div>
    <div class="message-container" id="messageContainer"></div>
    <div class="input-container" id="inputContainer">
        <label class="input-label" for="userInput">Ask Bixx Anything</label>
        <input type="text" class="input-text" id="userInput">
        <div class="button-group">
            <button onclick="sendMessage()" class="circle-button">
                <img src="up-arrow.png" alt="Send">
            </button>
        </div>
    </div>
    <div class="example-buttons" id="exampleButtons">
        <button class="example-button" onclick="useExamplePrompt('Generate me an image of a futuristic city')">
            <i class="fas fa-image button-icon"></i>
            Generate Image
        </button>
        <button class="example-button" onclick="useExamplePrompt('Write me a Python script to sort a list')">
            <i class="fas fa-code button-icon"></i>
            Code Example
        </button>
        <button class="example-button" onclick="useExamplePrompt('Explain quantum computing in simple terms')">
            <i class="fas fa-brain button-icon"></i>
            Learn Something
        </button>
    </div>

<script>
    // Get the current host and protocol
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const host = window.location.host;
    const ws = new WebSocket(`${protocol}//${host}`);
    
    const messageContainer = document.getElementById('messageContainer');
    const title = document.getElementById('title');
    const inputContainer = document.getElementById('inputContainer');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const themeButton = document.getElementById('theme-button');
    const userInput = document.getElementById('userInput');
    const sendButton = document.querySelector('.circle-button');

    let messageSent = false;
    let currentAiMessageDiv = null;
    let isWaitingForResponse = false;
    let isWaitingForImage = false;

    // Hide loader initially
    const topLoader = document.querySelector('.header .loader');
    if(topLoader) topLoader.style.display = 'none';

    function disableInput() {
        userInput.disabled = true;
        sendButton.style.opacity = '0.5';
        sendButton.style.cursor = 'not-allowed';
    }

    function enableInput() {
        userInput.disabled = false;
        sendButton.style.opacity = '1';
        sendButton.style.cursor = 'pointer';
    }

    ws.onopen = () => {
        console.log('Cooked By Omer AIðŸ”¥');
    };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);

            if (data.role === 'user') {
                currentAiMessageDiv = null;
                isWaitingForResponse = true;
                disableInput();
                scrollToBottom();

            } else if (data.role === 'ai') {
                let content = data.content;
                let displayText = content;
                let showLoading = false;

                const promptIndex = content.indexOf('_prompt');
                if (promptIndex !== -1) {
                    displayText = content.substring(0, promptIndex).trim();
                    showLoading = true;
                    isWaitingForImage = true;

                    // Create an AI message element for image generation status
                    const aiMessageElement = document.createElement('div');
                    aiMessageElement.className = 'message-bubble ai-message image-generating';
                    aiMessageElement.innerHTML = `
                        <div class="flex items-start gap-4">
                          <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-blue-200 font-medium">B</div>
                          <div class="flex-1">
                            <div class="whitespace-pre-wrap text-sm">Generating image...</div>
                            <div class="placeholder"></div>
                            <div class="loader"></div>
                          </div>
                        </div>
                    `;
                    messageContainer.appendChild(aiMessageElement);
                    setTimeout(scrollToBottom, 50);

                }

                if (displayText.length > 0 && !showLoading) {
                    if (!currentAiMessageDiv) {
                        currentAiMessageDiv = document.createElement('div');
                        currentAiMessageDiv.className = 'ai-message';
                        messageContainer.appendChild(currentAiMessageDiv);
                    }
                    currentAiMessageDiv.textContent += displayText;
                    scrollToBottom();
                }

                if (!showLoading) {
                    isWaitingForResponse = false;
                    if (!isWaitingForImage) {
                        enableInput();
                    }
                }

            } else if (data.role === 'image') {
                const aiMessageElements = messageContainer.querySelectorAll('.ai-message.image-generating');
                const lastAiMessageElement = aiMessageElements[aiMessageElements.length - 1];

                if (lastAiMessageElement) {
                    const contentDiv = lastAiMessageElement.querySelector('.flex-1');
                    if (contentDiv) {
                        const loaderDiv = contentDiv.querySelector('.loader');
                        const placeholderDiv = contentDiv.querySelector('.placeholder');
                        contentDiv.innerHTML = '';
                        if (placeholderDiv) {
                            contentDiv.appendChild(placeholderDiv);
                        }
                        if (loaderDiv) {
                            contentDiv.appendChild(loaderDiv);
                        }

                        const img = document.createElement('img');
                        img.src = data.content;
                        img.alt = '\u200B';
                        Object.assign(img.style, {
                            maxWidth: '100%',
                            borderRadius: '8px',
                            marginTop: '0',
                            position: 'absolute',
                            top: '50%',
                            left: '75%',
                            transform: 'translate(-50%, -50%)',
                            zIndex: '2'
                        });

                        img.onclick = function() {
                            const newWindow = window.open();
                            newWindow.document.write(`
                                <html>
                                <head>
                                    <title>Generated Image</title>
                                    <style>
                                        body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #161618; }
                                        img { max-width: 100%; max-height: 100vh; object-fit: contain; }
                                    </style>
                                </head>
                                <body>
                                    <img src="${data.content}" alt="\u200B">
                                </body>
                                </html>
                            `);
                        };
                        img.style.cursor = 'pointer';

                        img.onload = () => {
                            if (placeholderDiv) {
                                placeholderDiv.remove();
                            }
                            isWaitingForImage = false;
                            if (!isWaitingForResponse) {
                                enableInput();
                            }
                            scrollToBottom();
                        };

                        img.onerror = () => {
                            contentDiv.textContent = 'Image failed to load!';
                            lastAiMessageElement.classList.remove('image-generating');
                            lastAiMessageElement.classList.add('image-error');
                            if (placeholderDiv) {
                                placeholderDiv.remove();
                            }
                            isWaitingForImage = false;
                            if (!isWaitingForResponse) {
                                enableInput();
                            }
                            scrollToBottom();
                        };

                        contentDiv.appendChild(img);
                        lastAiMessageElement.classList.remove('image-generating');
                    }
                }
            }

            if (!messageSent && data.role !== 'image') {
                messageSent = true;
                title.classList.add('hidden');
                inputContainer.classList.add('moved-down');
                scrollToBottom();
            }
        } catch (error) {
            enableInput();
        }
    };

    function scrollToBottom() {
        const messageContainer = document.getElementById('messageContainer');
        messageContainer.scrollTo({ top: messageContainer.scrollHeight, behavior: 'smooth' });
    }

    function sendMessage() {
        if (isWaitingForResponse || isWaitingForImage) return;

        const input = document.getElementById('userInput');
        const message = input.value.trim();
        if (!message) return;

        const userMessage = message.replace(/\n+/g, ' ').trim();
        const messageDiv = document.createElement('div');
        messageDiv.className = 'user-message';
        messageDiv.textContent = userMessage;
        messageContainer.appendChild(messageDiv);

        ws.send(userMessage);
        input.value = '';
        dropdownMenu.classList.remove('active');

        const exampleButtons = document.getElementById('exampleButtons');
        if (exampleButtons) {
            exampleButtons.classList.add('hidden');
        }

        setTimeout(scrollToBottom, 100);
    }

    function useExamplePrompt(prompt) {
        const input = document.getElementById('userInput');
        input.value = prompt;
        input.focus();
    }

    function toggleDropdown() {
        dropdownMenu.classList.toggle('active');
    }

    function newChat() {
        messageContainer.innerHTML = '';
        messageSent = false;
        title.classList.remove('hidden');
        inputContainer.classList.remove('moved-down');
        const exampleButtons = document.getElementById('exampleButtons');
        if (exampleButtons) {
            exampleButtons.classList.remove('hidden');
        }
        currentAiMessageDiv = null;
        dropdownMenu.classList.remove('active');
        scrollToBottom();
    }

    function toggleTheme() {
        document.body.classList.toggle('light-theme');
        const isLight = document.body.classList.contains('light-theme');
        themeButton.textContent = isLight ? 'Switch to Dark Theme' : 'Switch to Light Theme';
        dropdownMenu.classList.remove('active');
    }

    document.getElementById('userInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isWaitingForResponse && !isWaitingForImage) {
            sendMessage();
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.profile-container')) {
            dropdownMenu.classList.remove('active');
        }
    });

    scrollToBottom();
</script>
</body>
</html>
